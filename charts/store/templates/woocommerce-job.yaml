{{- if eq .Values.engine "woocommerce" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: woocommerce-setup
  namespace: {{ .Release.Namespace }}
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: wordpress:cli
          command:
            - sh
            - -c
            - |
              echo "Waiting for WordPress HTTP..."
              until curl -s http://wordpress:80 > /dev/null; do
                sleep 5
              done

              echo "Downloading WordPress core..."
              wp core download --path=/var/www/html --allow-root

              echo "Creating wp-config..."
              wp config create \
                --dbname=wordpress \
                --dbuser=$WORDPRESS_DB_USER \
                --dbpass=$WORDPRESS_DB_PASSWORD \
                --dbhost=mysql \
                --path=/var/www/html \
                --allow-root

              echo "Installing WordPress..."
              wp core install \
                --url=http://localhost \
                --title="Auto Store" \
                --admin_user=admin \
                --admin_password=admin123 \
                --admin_email=admin@example.com \
                --skip-email \
                --path=/var/www/html \
                --allow-root

              echo "Installing WooCommerce..."
              wp plugin install woocommerce --activate --path=/var/www/html --allow-root

              echo "Setup complete."
          env:
            - name: WORDPRESS_DB_USER
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: username
            - name: WORDPRESS_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: password
          volumeMounts:
            - name: wordpress-data
              mountPath: /var/www/html
      volumes:
        - name: wordpress-data
          persistentVolumeClaim:
            claimName: wordpress-pvc
{{- end }}
